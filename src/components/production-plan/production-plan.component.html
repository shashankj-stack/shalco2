
<div class="container mx-auto px-6 py-8">
  @switch (view()) {
    @case ('list') {
      <div class="flex justify-between items-center">
        <h3 class="text-gray-700 dark:text-gray-200 text-3xl font-medium">Production Plans</h3>
        <button (click)="showCreateView()" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-300">
          <i class="fas fa-plus mr-2"></i>
          Create Plan
        </button>
      </div>
      <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
              <tr>
                <th class="px-6 py-3">Plan Name</th>
                <th class="px-6 py-3">Status</th>
                <th class="px-6 py-3">Items</th>
                <th class="px-6 py-3">Last Modified</th>
                <th class="px-6 py-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for(plan of plans(); track plan.id) {
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                  <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ plan.name }}</td>
                  <td class="px-6 py-4">
                     <span [class]="'px-2 py-1 font-semibold leading-tight rounded-full ' + 
                      (plan.status === 'Finalized' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-700 dark:text-indigo-100' :
                       plan.status === 'Approved' ? 'bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100' :
                       plan.status === 'Submitted' || plan.status === 'Under Review' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-700 dark:text-yellow-100' :
                       plan.status === 'Rejected' ? 'bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100' :
                       'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-100')">
                       @if(plan.status === 'Finalized') { <i class="fas fa-lock text-xs mr-1"></i> }
                      {{ plan.status }}
                    </span>
                  </td>
                  <td class="px-6 py-4">{{ plan.items.length }}</td>
                  <td class="px-6 py-4">{{ plan.lastModified | slice:0:10 }}</td>
                  <td class="px-6 py-4 flex items-center space-x-3">
                    <button (click)="showEditView(plan)" [disabled]="plan.status !== 'Draft'" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-200 disabled:text-gray-400 disabled:cursor-not-allowed">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button (click)="onDeletePlan(plan)" [disabled]="plan.status !== 'Draft'" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200 disabled:text-gray-400 disabled:cursor-not-allowed">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              } @empty {
                 <tr><td colspan="5" class="text-center p-4">No production plans found.</td></tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
    @case ('create') {
      <div>
        <div class="flex justify-between items-center">
          <h3 class="text-gray-700 dark:text-gray-200 text-3xl font-medium">Create New Production Plan</h3>
          <button (click)="showListView()" class="text-indigo-600 hover:underline">
            &larr; Back to List
          </button>
        </div>
        <div class="mt-4 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
          <h4 class="text-lg font-semibold">Step 1: Select Approved Demands</h4>
          <div class="mt-4 max-h-96 overflow-y-auto border dark:border-gray-600 rounded-lg">
             <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                <tr>
                  <th class="px-6 py-3 w-12"><input type="checkbox" disabled></th>
                  <th class="px-6 py-3">SKU</th>
                  <th class="px-6 py-3">Quantity</th>
                  <th class="px-6 py-3">Date</th>
                </tr>
              </thead>
              <tbody>
                @for(demand of availableDemands(); track demand.id) {
                  <tr class="border-b dark:border-gray-700">
                    <td class="px-6 py-4"><input type="checkbox" (change)="onDemandSelection($event, demand)" class="rounded"></td>
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ demand.sku }}</td>
                    <td class="px-6 py-4">{{ demand.quantity }}</td>
                    <td class="px-6 py-4">{{ demand.date }}</td>
                  </tr>
                } @empty {
                  <tr><td colspan="4" class="text-center p-4">No available demands to create a plan from.</td></tr>
                }
              </tbody>
            </table>
          </div>
          <div class="mt-6 flex justify-end">
            <button (click)="createPlanFromSelection()" [disabled]="selectedDemands().length === 0" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-300 disabled:bg-indigo-400 disabled:cursor-not-allowed">
              Create Plan with {{ selectedDemands().length }} items
              <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>
    }
    @case ('edit') {
      @if(currentPlan(); as plan) {
        <form [formGroup]="planForm" (ngSubmit)="savePlan()">
          <div class="flex justify-between items-center">
            <h3 class="text-gray-700 dark:text-gray-200 text-3xl font-medium">Edit Plan</h3>
            <button type="button" (click)="showListView()" class="text-indigo-600 hover:underline">
              &larr; Back to List
            </button>
          </div>
          <div class="mt-4 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="mb-6">
              <label for="planName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Plan Name</label>
              <input type="text" id="planName" formControlName="name" class="mt-1 block w-full md:w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            </div>
            
            <h4 class="text-lg font-semibold">Plan Items</h4>
             <div class="mt-4 overflow-x-auto border dark:border-gray-600 rounded-lg">
              <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" formArrayName="items">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                   <tr>
                    <th class="px-6 py-3">SKU</th>
                    <th class="px-6 py-3">Quantity</th>
                    <th class="px-6 py-3">Date</th>
                  </tr>
                </thead>
                <tbody>
                  @for(item of planItems.controls; track item.value.id; let i = $index) {
                    <tr [formGroupName]="i" class="border-b dark:border-gray-700">
                      <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ item.value.sku }}</td>
                      <td class="px-6 py-4">
                        <input type="number" formControlName="quantity" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                      </td>
                       <td class="px-6 py-4">
                        <input type="date" formControlName="date" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
              <button type="button" (click)="savePlan()" [disabled]="planForm.invalid" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500 disabled:bg-gray-200 disabled:cursor-not-allowed">
                Save Draft
              </button>
              <button type="button" (click)="savePlan(true)" [disabled]="planForm.invalid" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-400 disabled:cursor-not-allowed">
                Save & Submit for Review
              </button>
            </div>
          </div>
        </form>
      }
    }
  }
</div>
